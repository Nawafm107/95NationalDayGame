<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>لعبة الاسئلة</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css"/>
</head>
<body dir="rtl">
    <div class="start_btn">
        <button id="start-quiz-btn">ابدأ المسابقة</button>
        
        <button class="show-leaderboard-btn" style="margin-top:15px;width:100%">عرض المتصدرين</button>
    </div>

    <div class="quiz_box">
        <header>
            <div class="title">عزنا بطبعنا</div>
            <div class="timer">
                <div class="time_left_txt">الوقت المتبقي</div>
                <div class="timer_sec">60</div>
            </div>
            <div class="time_line"></div>
        </header>
        <section>
            <div class="que_text"></div>
            <div class="option_list"></div>
        </section>

        <footer>
            <div class="total_que"></div>
            <button class="next_btn">السؤال التالي</button>
        </footer>
    </div>
    
    <div class="result_box">
        <div class="complete_text">لقد انهيت المسابقة 🥳</div>
        <div class="score_text"></div>
        <div class="buttons">
            <button class="restart">اعادة الاسئلة</button>
            <button class="quit">الخروج</button>
        </div>
        <button class="show-leaderboard-btn" style="margin-top:10px;width:100%">عرض المتصدرين</button>
    </div>

    <script src="js/questions.js"></script>
    <script src="js/script.js"></script>
    <script type="module">
    // زر عرض المتصدرين تحت زر البداية
    document.querySelectorAll('.show-leaderboard-btn').forEach(btn => {
        btn.onclick = () => {
            if (typeof showLeaderboard === 'function') {
                showLeaderboard();
            }
        };
    });

    // لا يوجد صفحة ترحيب للمستوى السهل بعد الآن، إزالة أي كود يخص welcome_box
    // Import SDKs من CDN
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-analytics.js";
    import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

    // Config
    const firebaseConfig = {
        apiKey: "AIzaSyBR3cYuAwAuOMs2MtisFI3rmWFsEv-n8N8",
        authDomain: "leader-board-da464.firebaseapp.com",
        databaseURL: "https://leader-board-da464-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "leader-board-da464",
        storageBucket: "leader-board-da464.firebasestorage.app",
        messagingSenderId: "562083629862",
        appId: "1:562083629862:web:92ce91063127961b08cfe7",
        measurementId: "G-09TFYFR6VF"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const analytics = getAnalytics(app);
    const db = getDatabase(app);

    // --- كود لوحة المتصدرين ---
    // إنشاء عناصر اللوحة
    const leaderboardBox = document.createElement('div');
    leaderboardBox.className = 'leaderboard_box';
    leaderboardBox.style.display = 'none';
    leaderboardBox.innerHTML = `
        <div class="info-title"><span>لوحة المتصدرين</span></div>
        <div class="leaderboard-list"></div>
        <div class="buttons">
            <button class="quit">اغلاق</button>
        </div>
    `;
    document.body.appendChild(leaderboardBox);
    const leaderboardList = leaderboardBox.querySelector('.leaderboard-list');
    const leaderboardQuit = leaderboardBox.querySelector('.buttons .quit');

    leaderboardQuit.onclick = () => {
        leaderboardBox.style.display = 'none';
    };

    function showLeaderboard() {
        leaderboardBox.style.display = 'block';
        leaderboardBox.classList.add('activeLeaderboard');
        leaderboardList.innerHTML = '<div>جاري التحميل...</div>';
        const scoresRef = ref(db, 'scores');
        onValue(scoresRef, (snapshot) => {
            const data = snapshot.val();
            if (!data) {
                leaderboardList.innerHTML = '<div>لا يوجد بيانات بعد.</div>';
                return;
            }
            // تحويل البيانات لمصفوفة وترتيبها تنازلياً
            const arr = Object.entries(data).map(([name, score]) => ({ name, score }));
            arr.sort((a, b) => b.score - a.score);
            leaderboardList.innerHTML = arr.map((item, i) =>
                `<div style=\"font-size:22px;margin:8px 0;display:flex;justify-content:space-between;\">
                    <span>${i+1}. ${item.name}</span>
                    <span>${item.score}</span>
                </div>`
            ).join('');
        }, { onlyOnce: true });
    }

    // حفظ النتيجة في قاعدة البيانات عند استقبال الحدث من script.js
    window.addEventListener('saveScore', e => {
        const { playerName, score } = e.detail;
        try {
            set(ref(db, 'scores/' + playerName), score);
        } catch(e) { /* تجاهل أي خطأ */ }
    });

    // --- نهاية كود لوحة المتصدرين ---
    </script>

</body>
</html>
